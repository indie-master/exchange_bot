# Exchange Bot
Exchange Bot — это телеграм-бот для автоматизации расчета обмена валют по текущим биржевым курсам на основе данных из источника app.exchangerate-api.com.
Этот проект включает в себя всё необходимое для быстрого развертывания на VPS.

Вам понадобится:

`API-ключ из app.exchangerate-api.com`

`BOT-Token вашего ТГ-бота`

## Ручная установка
Если нужно поднять бота локально или развернуть вручную, выполните следующие команды:

````bash
git clone https://github.com/indie-master/exchange_bot.git
cd exchange_bot

# (опционально) создайте виртуальное окружение
python3 -m venv .venv
source .venv/bin/activate

# установите зависимости
pip install -r requirements.txt

# добавьте переменные окружения
echo "BOT_TOKEN=ваш_токен" >> .env
echo "API_KEY=ваш_api_key" >> .env

# запустите бота
python3 exchange_bot.py
````

## Установка и запуск
Следуйте приведённым ниже шагам, чтобы установить и запустить бота на вашем сервере.

### Шаг 1: Подготовка
Убедитесь, что ваш сервер соответствует следующим требованиям:

**Операционная система:** `Linux (Ubuntu/Debian)`

**Python:** `3.8 или выше`

**Доступ к интернету**

**Установленные пакеты:** `git, python3-pip`

Если что-то из этого не установлено, скрипт сделает это за вас.

### Шаг 2: Скачивание и установка
1. Зайдите в терминал вашего сервера.
2. Скопируйте и выполните следующий набор команд:
### Скачиваем установочный скрипт
````
curl -O https://raw.githubusercontent.com/indie-master/exchange_bot/main/setup_exchange_bot.sh
````

### Делаем скрипт исполняемым
````
chmod +x setup_exchange_bot.sh
````

### Запускаем скрипт
````
./setup_exchange_bot.sh
````

### Шаг 3: Конфигурация
Во время выполнения скрипта вас попросят ввести два параметра:

`API_KEY` — ключ для подключения к Telegram API.

`BOT_TOKEN` — токен вашего Telegram-бота.

Эти данные будут автоматически сохранены в файл `.env`

### Шаг 4: Запуск
После завершения скрипта бот запустится автоматически.

Для проверки его работы, откройте файл логов:
````
tail -f bot.log
````
Убедитесь, что бот активен и работает корректно.

## Дополнительно
### CLI-менеджер (CBR-rates)
После установки проекта можно управлять ботом через интерактивный CLI.

```
cd ~/exchange_bot
./CBR-rates
```

Запуск команды `CBR-rates` без аргументов откроет меню со следующими действиями:

| Команда   | Что делает |
|-----------|------------|
| `status`  | Показывает, запущен ли бот, и путь к файлу логов. |
| `update`  | Выполняет `git pull --ff-only` для обновления кода. |
| `restart` | Останавливает и запускает бота заново. |
| `reload`  | Мягкий перезапуск для перечитывания `.env` и исходного кода. |
| `logs`    | Выводит последние строки файла `bot.log`. |
| `stop`    | Останавливает фоновый процесс бота. |
| `start`   | Запускает бота, если он не работает. |
| `delete`  | Останавливает бота и удаляет служебные файлы (`bot.log`, `bot.pid`). |

Любую команду можно вызвать напрямую, например `./CBR-rates status` или `./CBR-rates restart`.

### Запуск из любого каталога
Чтобы не переходить в каталог бота каждый раз, создайте симлинк и добавьте его в `$PATH`:

```
sudo ln -s /home/bot/exchange_bot/CBR-rates /usr/local/bin/CBR-rates
```

CLI автоматически перейдёт в каталог репозитория. Если симлинк находится вне каталога проекта, укажите путь к нему через переменную окружения `EXCHANGE_BOT_ROOT`:

```
export EXCHANGE_BOT_ROOT=/home/bot/exchange_bot
```

После этого `CBR-rates` можно запускать из любого места. Если вы уже находитесь в каталоге репозитория, достаточно выполнить `CBR-rates` (или даже `python CBR-rates`) — скрипт сам найдёт корень проекта. Он также поднимается вверх по текущему пути и найдёт `bot_cli.py`, даже если команда запущена из вложенной папки. Для единичного вызова вне репозитория можно передать путь напрямую, не меняя переменные:

```
CBR-rates -C /home/bot/exchange_bot status
```

Флаг `-C/--root` имеет приоритет над `EXCHANGE_BOT_ROOT`, и после обработки он не передаётся в сам CLI.

### Перезапуск бота
Если вам нужно перезапустить бота, выполните следующие команды:
````
cd ~/exchange_bot
source venv/bin/activate`
nohup python3 exchange_bot.py > bot.log 2>&1 &
````

### Остановка бота
Для остановки процесса найдите его ID и завершите:
````
ps aux | grep exchange_bot.py
kill <PROCESS_ID>
````

## Настройка через Systemd
### 1. Создайте файл сервиса:
Откройте редактор и создайте новый файл:

````
sudo nano /etc/systemd/system/exchange_bot.service
````

Добавьте следующую конфигурацию:
````
[Unit]
Description=Exchange Bot
After=network.target

[Service]
User=<ваш_пользователь>
WorkingDirectory=/<ваш_пользователь>/exchange_bot
ExecStart=/<ваш_пользователь>/exchange_bot/venv/bin/python3 exchange_bot.py
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
EnvironmentFile=/<ваш_пользователь>/exchange_bot/.env

[Install]
WantedBy=multi-user.target
````

Замените `<ваш_пользователь>` на имя вашего пользователя.

### 2. Перезагрузите Systemd и активируйте сервис:

````
sudo systemctl daemon-reload
sudo systemctl enable exchange_bot
````

### 3. Запустите бота:

````
sudo systemctl start exchange_bot
````

### 4. Рестарт после изменений:
После изменения токена или кода перезапустите сервис:

````
sudo systemctl restart exchange_bot
````

### 5. Проверка статуса:
Убедитесь, что бот работает:

````
sudo systemctl status exchange_bot
````

Настройка через Systemd автоматизирует перезапуск и упрощает управление ботом.

## Проблемы и решения
Скрипт выдаёт ошибку "requirements.txt не найден":

Убедитесь, что файл `requirements.txt` добавлен в репозиторий и содержит список всех зависимостей.
Бот не запускается:

Проверьте логи `(bot.log)` для получения дополнительной информации о проблеме.

Необходимо обновить код бота:

### Выполните следующие команды для обновления:
````
cd ~/exchange_bot
git pull
````
